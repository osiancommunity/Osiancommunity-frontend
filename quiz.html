<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OSIAN – Secure Quiz</title>

<link rel="stylesheet" href="assets/boxicons-local.css">

<style>
:root{
  --primary:#6d28d9;
  --danger:#ef4444;
  --bg:#f5f7fb;
  --card:#fff;
  --text:#0f172a;
  --muted:#6b7280;
  --radius:18px;
  --shadow:0 20px 50px rgba(0,0,0,.12);
}

*{box-sizing:border-box;font-family:Poppins,system-ui}
body{margin:0;background:var(--bg);color:var(--text)}

button{cursor:pointer}

/* ===== BUTTONS ===== */
.btn-primary{
  background:var(--primary);
  color:#fff;
  border:none;
  padding:12px 22px;
  border-radius:12px;
  font-weight:700;
}
.btn-secondary{
  background:#fff;
  border:1px solid #e5e7eb;
  color:var(--primary);
  padding:10px 16px;
  border-radius:12px;
  font-weight:600;
}
.btn-submit{
  background:var(--danger);
  color:#fff;
  border:none;
  padding:12px 26px;
  border-radius:12px;
  font-weight:800;
}

/* ===== MODALS ===== */
.modal-overlay{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,.6);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:3000;
}
.modal-overlay.active{display:flex}

.modal-content{
  background:var(--card);
  width:92%;
  max-width:520px;
  padding:26px;
  border-radius:20px;
  box-shadow:var(--shadow);
  animation:pop .25s ease;
  text-align:center;
}
@keyframes pop{
  from{transform:scale(.95);opacity:0}
  to{transform:scale(1);opacity:1}
}
.modal-content i{font-size:56px;color:var(--primary)}
.modal-content h2{margin:12px 0}
.modal-content p{color:var(--muted);font-size:15px}

/* ===== QUIZ CARD ===== */
.quiz-container{
  max-width:1000px;
  margin:24px auto;
  background:var(--card);
  border-radius:20px;
  box-shadow:var(--shadow);
  overflow:hidden;
}

.quiz-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:18px 22px;
  border-bottom:1px solid #e5e7eb;
}
.quiz-header-left{
  display:flex;
  align-items:center;
  gap:14px;
}
.logo{
  font-size:22px;
  font-weight:900;
  color:var(--primary);
}
.timer{
  font-weight:900;
  color:var(--danger);
  display:flex;
  gap:6px;
  align-items:center;
}

/* ===== PROGRESS ===== */
.progress-wrap{
  padding:0 22px;
}
.progress-bar{
  height:8px;
  background:#e5e7eb;
  border-radius:99px;
  overflow:hidden;
}
.progress{
  height:100%;
  width:0%;
  background:var(--primary);
  transition:.3s;
}

/* ===== WARNING ===== */
.warning-banner{
  background:#fff4e5;
  color:#92400e;
  padding:12px 18px;
  font-weight:700;
  display:none;
  gap:8px;
  align-items:center;
}

/* ===== MAIN ===== */
.quiz-main{padding:26px}
.question-header span{color:var(--primary);font-weight:700}
.question-header h2{margin:10px 0 24px}

/* ===== OPTIONS ===== */
.options-container{
  display:flex;
  flex-direction:column;
  gap:14px;
}
.option{
  padding:16px;
  border-radius:14px;
  border:2px solid #e5e7eb;
  font-size:16px;
  font-weight:600;
  cursor:pointer;
}
.option:hover{border-color:var(--primary)}
.option.selected{
  border-color:var(--primary);
  background:#ede9fe;
  box-shadow:0 0 0 2px rgba(109,40,217,.2);
}

/* ===== NAV ===== */
.quiz-navigation{
  margin-top:28px;
  display:flex;
  justify-content:flex-end;
}

/* ===== ERROR TEXT ===== */
.error-text{
  color:var(--danger);
  font-weight:700;
  margin-top:12px;
  display:none;
}
</style>
</head>

<body oncontextmenu="return false;">

<!-- INSTRUCTIONS -->
<div id="instructionModal" class="modal-overlay active">
  <div class="modal-content">
    <i class='bx bxs-error-circle'></i>
    <h2>Quiz Instructions</h2>
    <p>• Full-screen required<br>• No tab switching (3 warnings)<br>• Auto-submit on time end</p>
    <button class="btn-primary" onclick="startQuiz()">Start Quiz</button>
  </div>
</div>

<!-- CONFIRM SUBMIT -->
<div id="confirmModal" class="modal-overlay">
  <div class="modal-content">
    <i class='bx bxs-check-circle'></i>
    <h2>Submit Quiz?</h2>
    <p>You cannot change answers after submission.</p>
    <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:18px">
      <button class="btn-secondary" onclick="closeConfirm()">Cancel</button>
      <button class="btn-submit" onclick="finalSubmit()">Submit</button>
    </div>
  </div>
</div>

<!-- QUIZ -->
<div class="quiz-container" id="quizBox" style="display:none">

<header class="quiz-header">
  <div class="quiz-header-left">
    <button class="btn-secondary" onclick="history.back()">
      <i class='bx bx-arrow-back'></i> Back
    </button>
    <div class="logo">OSIAN</div>
  </div>
  <div class="timer"><i class='bx bx-time'></i> <span id="time">02:00</span></div>
</header>

<div class="progress-wrap">
  <div class="progress-bar">
    <div class="progress" id="progress"></div>
  </div>
</div>

<div id="warning" class="warning-banner">
  <i class='bx bxs-error'></i>
  Warning <span id="warnCount">1</span>/3 – Do not switch tabs
</div>

<main class="quiz-main">
  <div class="question-header">
    <span>Question 1 of 1</span>
    <h2>hiii</h2>
  </div>

  <div class="options-container">
    <div class="option" onclick="selectOption(this)">A &nbsp; hiii</div>
    <div class="option" onclick="selectOption(this)">B &nbsp; hiiii</div>
  </div>

  <div class="error-text" id="errorText">⚠ Please select an option before submitting</div>

  <div class="quiz-navigation">
    <button class="btn-submit" onclick="openConfirm()">Submit</button>
  </div>
</main>

</div>

<script>
let selected=false;
let warnings=0;
let time=120;

/* OPTION SELECT */
function selectOption(el){
  document.querySelectorAll('.option').forEach(o=>o.classList.remove('selected'));
  el.classList.add('selected');
  selected=true;
  document.getElementById('errorText').style.display='none';
}

/* CONFIRM */
function openConfirm(){
  if(!selected){
    document.getElementById('errorText').style.display='block';
    return;
  }
  document.getElementById('confirmModal').classList.add('active');
}
function closeConfirm(){
  document.getElementById('confirmModal').classList.remove('active');
}

/* SUBMIT (backend-confirmed) */
async function finalSubmit(autoReason){
  const confirmModal = document.getElementById('confirmModal');
  const quizBox = document.getElementById('quizBox');
  // Read auth and backend
  const token = localStorage.getItem('token');
  const user = JSON.parse(localStorage.getItem('user')||'null');
  const backendUrl = (location.hostname.endsWith('vercel.app'))
    ? 'https://osiancommunity-backend.vercel.app/api'
    : ((location.hostname === 'localhost' || location.hostname === '127.0.0.1')
        ? 'http://localhost:5000/api'
        : 'https://osiancommunity-backend.vercel.app/api');
  const params = new URLSearchParams(window.location.search);
  const quizId = params.get('id');

  if (!token || !user || !quizId){
    // Show meaningful error and do not fake success
    confirmModal.querySelector('h2').textContent = 'Submission Failed';
    confirmModal.querySelector('p').textContent = 'Missing auth or quiz ID. Please login and open a valid quiz.';
    confirmModal.classList.add('active');
    return;
  }

  // Build answers (single-question page)
  const options = Array.from(document.querySelectorAll('.options-container .option'));
  const selectedIndex = options.findIndex(el => el.classList.contains('selected'));
  if (selectedIndex < 0){
    document.getElementById('errorText').style.display='block';
    return;
  }

  // Show submitting state and block inputs
  confirmModal.classList.add('active');
  confirmModal.querySelector('h2').textContent = 'Submitting...';
  confirmModal.querySelector('p').textContent = 'Saving your answers to the server.';
  confirmModal.querySelector('.btn-submit')?.setAttribute('disabled','true');
  quizBox.style.pointerEvents = 'none';

  try {
    const res = await fetch(`${backendUrl}/results/submit`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
      body: JSON.stringify({
        quizId,
        userId: user._id,
        answers: [{ questionIndex: 0, selectedAnswer: selectedIndex, writtenAnswer: '', timeSpent: 0 }],
        timeTaken: 120 - time,
        cheatingViolation: autoReason ? autoReason : undefined
      })
    });
    const data = await res.json().catch(()=>({ success:false, message:'Invalid server response' }));
    if (!res.ok || !data || data.success === false){
      const msg = (data && data.message) ? data.message : `Server error (${res.status})`;
      confirmModal.querySelector('h2').textContent = 'Submission Failed';
      confirmModal.querySelector('p').textContent = msg;
      confirmModal.querySelector('.btn-submit')?.removeAttribute('disabled');
      quizBox.style.pointerEvents = 'auto';
      return;
    }

    // Success modal only after backend OK
    confirmModal.querySelector('h2').textContent = 'Quiz Submitted!';
    const r = data.result || {};
    confirmModal.querySelector('p').textContent = r.status === 'pending'
      ? 'Your responses are saved. Results will be declared in 8-10 hours.'
      : `Your score: ${r.score ?? '—'} / ${r.totalQuestions ?? '—'}`;
    // Lock UI and redirect safely
    document.querySelector('.quiz-navigation .btn-submit')?.setAttribute('disabled','true');
    setTimeout(function(){ window.location.href = 'dashboard-user.html'; }, 2500);
  } catch (e) {
    confirmModal.querySelector('h2').textContent = 'Submission Failed';
    confirmModal.querySelector('p').textContent = (e && e.message) ? e.message : 'Network error';
    confirmModal.querySelector('.btn-submit')?.removeAttribute('disabled');
    quizBox.style.pointerEvents = 'auto';
  }
}

/* START QUIZ */
function startQuiz(){
  document.getElementById('instructionModal').classList.remove('active');
  document.getElementById('quizBox').style.display='block';
  document.documentElement.requestFullscreen?.();
  startTimer();
}

/* TIMER */
async function startTimer(){
  const t=document.getElementById('time');
  const p=document.getElementById('progress');
  const interval=setInterval(()=>{
    let m=Math.floor(time/60);
    let s=time%60;
    t.textContent=`${m}:${s.toString().padStart(2,'0')}`;
    p.style.width=((120-time)/120*100)+"%";
    if(time--<=0){
      clearInterval(interval);
      finalSubmit('Timer expired');
    }
  },1000);
}

/* ANTI TAB */
window.addEventListener('blur',()=>{
  warnings++;
  document.getElementById('warning').style.display='flex';
  document.getElementById('warnCount').textContent=warnings;
  if(warnings>=3) finalSubmit('Anti-cheating violation');
});

// On load: block repeated attempts from backend
(async function(){
  try{
    const token = localStorage.getItem('token');
    const user = JSON.parse(localStorage.getItem('user')||'null');
    const params = new URLSearchParams(window.location.search);
    const quizId = params.get('id');
    const backendUrl = (location.hostname.endsWith('vercel.app'))
      ? 'https://osiancommunity-backend.vercel.app/api'
      : ((location.hostname === 'localhost' || location.hostname === '127.0.0.1')
          ? 'http://localhost:5000/api'
          : 'https://osiancommunity-backend.vercel.app/api');
    if (!token || !user || !quizId) return;
    const res = await fetch(`${backendUrl}/results/quiz/${quizId}`, { headers: { 'Authorization': `Bearer ${token}` } });
    if (!res.ok) return;
    const data = await res.json();
    const mine = Array.isArray(data && data.results) ? data.results.find(r => String(r.userId && r.userId._id || r.userId) === String(user._id)) : null;
    if (mine) {
      const confirmModal = document.getElementById('confirmModal');
      confirmModal.querySelector('h2').textContent = 'Already Attempted';
      confirmModal.querySelector('p').textContent = 'You have already attempted this quiz.';
      confirmModal.classList.add('active');
      setTimeout(function(){ window.location.href = 'dashboard-user.html'; }, 2000);
    }
  } catch(_){}
})();
</script>

</body>
</html>
