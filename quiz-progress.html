<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>OSIAN — My Quiz Progress</title>

    <!-- Boxicons CDN -->
    <link
      href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css"
      rel="stylesheet"
    />

    <style>
      /* ====== Variables & base ====== */
      :root {
        --bg: #f7fbff;
        --card: #ffffff;
        --accent: #4c8dff;
        --accent-2: #6a5cd8;
        --muted: #6b7380;
        --radius: 14px;
        --shadow-soft: 0 12px 32px rgba(20, 60, 120, 0.06);
        --shadow-strong: 0 18px 42px rgba(20, 60, 120, 0.08);
        --success: #10b981;
        --danger: #ef4444;
        font-family: "Poppins", system-ui, -apple-system, "Segoe UI", Roboto,
          Arial, sans-serif;
        color: #0f1724;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      /* page background */
      html,
      body {
        height: 100%;
        margin: 0;
        background: radial-gradient(
          900px 400px at 0% 0%,
          #f7fbff 0%,
          #eaf4ff 100%
        );
      }
      a {
        color: inherit;
        text-decoration: none;
      }
      button {
        font-family: inherit;
      }

      /* ====== APP LAYOUT ====== */
      .app {
        display: flex;
        min-height: 100vh;
        align-items: flex-start;
      }

      /* SIDEBAR (desktop only) */
      .sidebar {
        width: 260px;
        background: linear-gradient(180deg, #fff, #f6faff);
        border-right: 1px solid #eef4ff;
        padding: 18px;
        box-shadow: 8px 8px 24px rgba(0, 0, 0, 0.03);
        display: flex;
        flex-direction: column;
        gap: 12px;
        flex-shrink: 0;
      }
      .logo {
        font-weight: 700;
        color: var(--accent);
        font-size: 20px;
        margin-bottom: 8px;
      }
      .side-nav {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-top: 6px;
      }
      .side-nav a {
        display: flex;
        gap: 12px;
        align-items: center;
        padding: 10px;
        border-radius: 10px;
        color: var(--muted);
        font-weight: 600;
      }
      .side-nav a.active {
        background: linear-gradient(135deg, var(--accent), var(--accent-2));
        color: #fff;
        box-shadow: 0 6px 16px rgba(106, 92, 216, 0.12);
      }
      .sidebar-footer {
        margin-top: auto;
        font-size: 13px;
        color: var(--muted);
      }

      /* MAIN CONTENT (right) */
      .main {
        flex: 1;
        padding: 28px;
        min-width: 0; /* allow flex child shrinking */
      }

      /* Page container */
      .page {
        max-width: 1200px;
        margin: 0 auto;
      }

      /* HEADER */
      .header-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 18px;
      }
      .title-block h1 {
        font-size: clamp(28px, 5vw, 44px);
        margin: 0;
      }
      .title-block p {
        margin: 8px 0 0;
        color: var(--muted);
        font-size: clamp(14px, 2vw, 18px);
      }

      .header-actions {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .btn-ghost {
        background: var(--card);
        border: 1px solid #eef4ff;
        padding: 8px 12px;
        border-radius: 10px;
        cursor: pointer;
        box-shadow: var(--shadow-soft);
        display: inline-flex;
        gap: 8px;
        align-items: center;
        font-weight: 600;
      }

      /* GRID */
      .grid {
        display: grid;
        grid-template-columns: 340px 1fr;
        gap: 18px;
        align-items: start;
      }
      @media (max-width: 980px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }

      .card {
        background: var(--card);
        border-radius: var(--radius);
        padding: 18px;
        box-shadow: var(--shadow-soft);
        border: 1px solid #eef4ff;
      }

      /* PROFILE */
      .profile-card {
        text-align: center;
        padding-bottom: 18px;
      }
      .profile-avatar {
        width: 96px;
        height: 96px;
        border-radius: 999px;
        overflow: hidden;
        margin: 0 auto 12px;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.06);
        border: 6px solid #fff;
      }
      .profile-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }
      .profile-name {
        font-weight: 700;
        font-size: 18px;
        margin-top: 6px;
      }
      .profile-meta {
        color: var(--muted);
        font-size: 13px;
        margin-top: 4px;
      }

      .badges-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
        margin-top: 12px;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: #f6f9ff;
        border-radius: 12px;
        padding: 8px 12px;
        border: 1px solid #e8f2ff;
        font-weight: 600;
        color: var(--accent);
        font-size: 13px;
      }

      /* KPIs */
      .kpi-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
        margin-top: 18px;
      }
      @media (min-width: 720px) {
        .kpi-grid {
          grid-template-columns: 1fr 1fr;
        }
      }
      .kpi {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 14px;
        border-radius: 12px;
        background: linear-gradient(180deg, #fff, #fbfdff);
        box-shadow: var(--shadow-soft);
      }
      .kpi i {
        font-size: 28px;
        color: var(--accent);
        background: linear-gradient(180deg, #f0f6ff, #fff);
        padding: 10px;
        border-radius: 10px;
      }
      .kpi .value {
        font-weight: 700;
        font-size: 18px;
      }
      .kpi .label {
        color: var(--muted);
        font-size: 13px;
      }

      /* CONTENT HEADER */
      .content-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 14px;
      }
      .content-controls {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      /* QUIZZES GRID */
      .quizzes-grid {
        display: grid;
        gap: 18px;
        grid-template-columns: repeat(3, 1fr);
      }
      @media (max-width: 1000px) {
        .quizzes-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }
      @media (max-width: 600px) {
        .quizzes-grid {
          grid-template-columns: 1fr;
        }
      }

      .quiz-card {
        border-radius: 12px;
        overflow: hidden;
        background: var(--card);
        box-shadow: var(--shadow-soft);
        border: 1px solid #eef4ff;
        display: flex;
        flex-direction: column;
      }
      .quiz-hero {
        width: 100%;
        height: 150px;
        overflow: hidden;
        background: #f4f8ff;
      }
      .quiz-hero img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }
      .quiz-body {
        padding: 14px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .quiz-title {
        font-weight: 700;
      }
      .quiz-meta {
        font-size: 13px;
        color: var(--muted);
      }
      .quiz-actions {
        display: flex;
        gap: 8px;
        margin-top: auto;
      }
      .btn {
        padding: 9px 14px;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        font-weight: 700;
      }
      .btn-primary {
        background: linear-gradient(90deg, var(--accent), var(--accent-2));
        color: #fff;
        box-shadow: 0 8px 20px rgba(76, 141, 255, 0.18);
      }
      .btn-ghost-sm {
        background: #fff;
        border: 1px solid #dbe9ff;
        color: var(--accent);
        padding: 8px 12px;
        border-radius: 10px;
      }

      /* HISTORY TABLE */
      .table-wrap {
        margin-top: 18px;
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid #eef4ff;
        background: var(--card);
        box-shadow: var(--shadow-soft);
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        padding: 12px 14px;
        text-align: left;
        border-bottom: 1px solid #f2f6fb;
      }
      th {
        background: #fff;
        font-weight: 700;
        color: var(--muted);
      }
      .result-pill {
        padding: 6px 10px;
        border-radius: 999px;
        font-weight: 700;
        color: #fff;
      }
      .result-pass {
        background: var(--success);
      }
      .result-fail {
        background: var(--danger);
      }
      .result-pending {
        background: #f59e0b;
      }

      /* PAGINATION */
      .pager {
        display: flex;
        align-items: center;
        gap: 10px;
        justify-content: flex-end;
        padding: 12px;
      }
      .pager .page-info {
        color: var(--muted);
      }
      .pager button {
        background: #fff;
        border: 1px solid #e8f0fb;
        padding: 8px 12px;
        border-radius: 10px;
        cursor: pointer;
      }

      /* BOTTOM NAV (shows on mobile) */
      .bottom-nav {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        height: 74px;
        background: var(--card);
        border-top: 1px solid #eef4ff;
        display: flex;
        justify-content: space-around;
        align-items: center;
        z-index: 9999;
        box-shadow: 0 -6px 20px rgba(10, 20, 40, 0.04);
      }
      .bottom-nav a {
        display: flex;
        flex-direction: column;
        align-items: center;
        color: #7a7a7a;
        font-size: 12px;
        text-decoration: none;
      }
      .bottom-nav a.active {
        color: var(--accent);
      }
      .bottom-nav i {
        font-size: 20px;
        margin-bottom: 4px;
      }

      /* HELPERS */
      .muted {
        color: var(--muted);
      }
      .center {
        text-align: center;
      }
      .spacer {
        height: 18px;
      }

      /* ===== MOBILE ADJUSTMENTS =====
       Make the page match dashboard mobile:
       - Hide left sidebar
       - Move header spacing / reduce paddings
       - Make cards full width and stacked nicely
    */
      @media (max-width: 980px) {
        .sidebar {
          display: none;
        } /* hide left sidebar on small screens */
        .main {
          padding: 18px;
        }
        .page {
          padding-bottom: 120px;
        } /* give room for bottom nav */

        /* headers slightly smaller */
        .title-block h1 {
          font-size: 28px;
        }
        .title-block p {
          font-size: 14px;
        }

        /* profile card: make full width and more compact */
        .profile-card {
          padding: 14px;
          text-align: center;
        }
        .profile-avatar {
          width: 84px;
          height: 84px;
          border-width: 5px;
          margin-bottom: 10px;
        }

        /* KPI: single column stacking */
        .kpi {
          padding: 12px;
        }
        .kpi .value {
          font-size: 16px;
        }

        /* right column content: cards full width */
        .card {
          padding: 14px;
          border-radius: 12px;
        }
        .quiz-hero {
          height: 140px;
        }
        .quiz-hero img {
          object-position: center;
        }

        /* table: increase touch target and spacing */
        th,
        td {
          padding: 12px 10px;
          font-size: 14px;
        }

        /* small screens: ensure quizzes grid stacks to single column */
        .quizzes-grid {
          grid-template-columns: 1fr !important;
        }

        /* show bottom nav (already present) */
        .bottom-nav {
          display: flex;
        }
      }

      /* larger desktop tweaks for visual balance */
      @media (min-width: 1400px) {
        .page {
          max-width: 1400px;
        }
        .quizzes-grid {
          grid-template-columns: repeat(4, 1fr);
        }
      }
    </style>
  </head>
  <body>
    <div class="app" role="application">
      <!-- Sidebar (left) -->
      <aside class="sidebar" role="navigation" aria-label="Main sidebar">
        <div class="logo">OSIAN</div>

        <nav class="side-nav" aria-label="Main nav">
          <a href="dashboard-user.html" id="side-home"
            ><i class="bx bx-grid-alt"></i><span>Dashboard</span></a
          >
          <a href="quiz-progress.html" id="side-progress" class="active"
            ><i class="bx bx-file-blank"></i><span>My Progress</span></a
          >
          <a href="leaderboard.html" id="side-leaderboard"
            ><i class="bx bxs-trophy"></i><span>Leaderboard</span></a
          >
          <a href="notifications.html" id="side-notifs"
            ><i class="bx bx-bell"></i><span>Notifications</span></a
          >
          <a href="profile.html" id="side-profile"
            ><i class="bx bxs-user"></i><span>Profile</span></a
          >
        </nav>

        <div class="sidebar-footer">
          <button
            id="sidebar-dashboard-btn"
            class="btn-ghost"
            style="width: 100%; display: flex; justify-content: center"
          >
            <i class="bx bx-grid-alt"></i> Dashboard
          </button>
          <div style="height: 8px"></div>
          <button
            id="sidebar-logout"
            class="btn-ghost"
            style="width: 100%; display: flex; justify-content: center"
          >
            <i class="bx bx-log-out"></i> Log Out
          </button>
        </div>
      </aside>

      <!-- Main area -->
      <main class="main" role="main">
        <div class="page">
          <!-- Header -->
          <div class="header-row">
            <div class="title-block" aria-hidden="false">
              <h1>My Quiz Progress</h1>
              <p>Track your scores, attempts, and performance over time.</p>
            </div>

            <div
              class="header-actions"
              role="toolbar"
              aria-label="Page actions"
            >
              <select
                id="searchInput"
                aria-label="Filter by category"
                style="
                  padding: 8px;
                  border-radius: 8px;
                  border: 1px solid #eef4ff;
                "
              >
                <option value="">All categories</option>
                <option>Technical</option>
                <option>General Knowledge</option>
                <option>Sports</option>
                <option>Law</option>
              </select>

              <button class="btn-ghost" id="btn-switch-view">
                <i class="bx bx-grid-alt"></i> Dashboard
              </button>
              <button class="btn-ghost" id="btn-logout-header">
                <i class="bx bx-log-out"></i> Log Out
              </button>
            </div>
          </div>

          <!-- Two-column grid -->
          <div class="grid" role="region" aria-label="Content">
            <!-- Left column: profile & KPIs -->
            <div>
              <div class="card profile-card" id="profileCard">
                <div class="profile-avatar" id="profileAvatarWrap">
                  <img id="profileAvatar" src="" alt="Profile" />
                </div>
                <div class="profile-name" id="profileName">Kudoz Kundan</div>
                <div class="profile-meta" id="profileMeta">
                  Student • Computer Science
                </div>

                <div class="badges-row" id="badgesRow"></div>

                <div class="spacer"></div>

                <div class="kpi-grid" aria-hidden="false">
                  <div class="kpi">
                    <i class="bx bx-file-blank"></i>
                    <div>
                      <div class="value" id="kpiAttempt">0</div>
                      <div class="label">Quizzes Attempted</div>
                    </div>
                  </div>

                  <div class="kpi">
                    <i class="bx bx-check-double"></i>
                    <div>
                      <div class="value" id="kpiPassed">0</div>
                      <div class="label">Quizzes Passed</div>
                    </div>
                  </div>

                  <div class="kpi">
                    <i class="bx bxs-bar-chart-alt-2"></i>
                    <div>
                      <div class="value" id="kpiAvg">0%</div>
                      <div class="label">Average Score</div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="card" style="margin-top: 12px">
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                  "
                >
                  <div>
                    <strong>Quick actions</strong>
                    <div class="muted" style="font-size: 13px; margin-top: 6px">
                      Start recent quizzes or view leaderboard
                    </div>
                  </div>
                  <div style="display: flex; gap: 8px">
                    <button class="btn btn-ghost-sm" id="btn-refresh">
                      Refresh
                    </button>
                    <button class="btn btn-ghost-sm" id="btnNewQuiz">
                      New
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Right column: quizzes & history -->
            <div>
              <div class="content-header" aria-hidden="false">
                <h2>My Registered Quizzes</h2>
                <div class="content-controls" aria-hidden="true"></div>
              </div>

              <div
                id="registeredQuizzesWrap"
                class="quizzes-grid card"
                style="padding: 16px"
                aria-live="polite"
              >
                <!-- JS will render quiz cards here -->
              </div>

              <div class="pager" style="margin-top: 12px">
                <div class="page-info" id="regPageInfo">Page 1 of 1</div>
                <div style="flex: 1"></div>
                <button id="regPrev">Prev</button>
                <button id="regNext">Next</button>
              </div>

              <h2 style="margin-top: 18px">My Quiz History</h2>
              <div class="table-wrap" role="region" aria-label="Quiz history">
                <table id="historyTable" aria-describedby="historyDesc">
                  <thead>
                    <tr>
                      <th>Quiz Title</th>
                      <th>Category</th>
                      <th>Type</th>
                      <th>Date Attempted</th>
                      <th>Score</th>
                      <th>Result</th>
                    </tr>
                  </thead>
                  <tbody id="historyBody"></tbody>
                </table>

                <div class="pager">
                  <div class="page-info" id="histPageInfo">Page 1 of 1</div>
                  <div style="flex: 1"></div>
                  <button id="histPrev">Prev</button>
                  <button id="histNext">Next</button>
                </div>
              </div>
            </div>
          </div>
          <!-- grid end -->
        </div>
        <!-- page end -->
      </main>
    </div>
    <!-- app end -->

    <!-- bottom nav (mobile) -->
    <nav class="bottom-nav" role="navigation" aria-label="mobile nav">
      <a href="dashboard-user.html" id="nav-dashboard" class="active"
        ><i class="bx bxs-dashboard"></i><span>Home</span></a
      >
      <a href="quiz-progress.html" id="nav-quizzes"
        ><i class="bx bx-file-blank"></i><span>Quizzes</span></a
      >
      <a href="leaderboard.html" id="nav-leaderboard"
        ><i class="bx bxs-trophy"></i><span>Leaderboard</span></a
      >
      <a href="notifications.html" id="nav-notifs"
        ><i class="bx bx-bell"></i><span>Alerts</span></a
      >
      <a href="profile.html" id="nav-profile"
        ><i class="bx bxs-user"></i><span>Profile</span></a
      >
    </nav>

    <script>
      (function () {
        // backend url detection (same logic you used earlier)
        const backendUrl = location.hostname.endsWith("vercel.app")
          ? "https://osiancommunity-backend.vercel.app/api"
          : location.hostname === "localhost" ||
            location.hostname === "127.0.0.1"
          ? "http://localhost:5000/api"
          : "https://osiancommunity-backend.vercel.app/api";

        // SAMPLE data fallback (so page always renders)
        const SAMPLE_REGISTERED = [
          {
            id: "r1",
            title: "Handwritten DS Notes",
            category: "Technical",
            type: "Regular",
            date: "2025-12-01",
            image:
              "https://images.unsplash.com/photo-1515879218367-8466d910aaa4?auto=format&fit=crop&w=1200&q=80",
          },
          {
            id: "r2",
            title: "Software Dev Basics",
            category: "Technical",
            type: "Regular",
            date: "2025-12-05",
            image:
              "https://images.unsplash.com/photo-1526378721006-1b3b0d0c2b56?auto=format&fit=crop&w=1200&q=70",
          },
          {
            id: "r3",
            title: "GK Quick Quiz",
            category: "General Knowledge",
            type: "Regular",
            date: "2025-12-03",
            image:
              "https://images.unsplash.com/photo-1526045612212-70caf35c14df?auto=format&fit=crop&w=1200&q=80",
          },
          {
            id: "r4",
            title: "Networks Practice",
            category: "Technical",
            type: "Live",
            date: "2025-11-20",
            image:
              "https://images.unsplash.com/photo-1559757175-5703870d8ff2?auto=format&fit=crop&w=1200&q=80",
          },
          {
            id: "r5",
            title: "Sports Trivia",
            category: "Sports",
            type: "Regular",
            date: "2025-12-02",
            image:
              "https://images.unsplash.com/photo-1509228627156-0d4e5a4a9b99?auto=format&fit=crop&w=1200&q=80",
          },
        ];
        const SAMPLE_HISTORY = [
          {
            title: "technical",
            category: "technical",
            type: "regular",
            date: "2025-12-09",
            score: "1 / 3",
            result: "Fail",
          },
          {
            title: "Diljot",
            category: "technical",
            type: "regular",
            date: "2025-12-07",
            score: "0 / 1",
            result: "Fail",
          },
          {
            title: "GK Quick Quiz",
            category: "General Knowledge",
            type: "regular",
            date: "2025-12-03",
            score: "3 / 3",
            result: "Pass",
          },
          {
            title: "Software Dev Basics",
            category: "Technical",
            type: "regular",
            date: "2025-12-05",
            score: "5 / 6",
            result: "Pass",
          },
        ];

        // helpers
        function el(sel) {
          return document.querySelector(sel);
        }
        function qAll(sel) {
          return Array.from(document.querySelectorAll(sel));
        }
        function escapeHtml(s) {
          if (!s) return "";
          return String(s).replace(
            /[&<>"]/g,
            (c) =>
              ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;" }[c])
          );
        }

        // image fallback (on real error only)
        function fallbackImg(imgEl) {
          if (!imgEl || !imgEl.parentElement) return;
          imgEl.remove();
          const ph = document.createElement("div");
          ph.style.width = "100%";
          ph.style.height = "100%";
          ph.style.display = "flex";
          ph.style.alignItems = "center";
          ph.style.justifyContent = "center";
          ph.style.background = "#f4f8ff";
          ph.style.color = "var(--accent)";
          ph.style.fontWeight = "700";
          ph.textContent = "Image";
          imgEl.parentElement.appendChild(ph);
        }

        // logout util
        function clearCookie(name) {
          try {
            document.cookie = name + "=; Max-Age=0; path=/; SameSite=Lax";
            document.cookie =
              name + "=; Expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/";
          } catch (e) {}
        }
        async function doLogout() {
          try {
            await fetch(backendUrl + "/auth/logout", {
              method: "POST",
              credentials: "include",
            }).catch(() => {});
            try {
              localStorage.removeItem("token");
            } catch (e) {}
            try {
              localStorage.removeItem("user");
            } catch (e) {}
            try {
              localStorage.removeItem("osianAuthToken");
            } catch (e) {}
            try {
              localStorage.removeItem("osianUserData");
            } catch (e) {}
            clearCookie("authToken");
            clearCookie("osianAuth");
            if ("serviceWorker" in navigator) {
              navigator.serviceWorker
                .getRegistrations()
                .then((r) => r.forEach((x) => x.unregister().catch(() => {})))
                .catch(() => {});
            }
            window.location.replace("/index.html");
          } catch (err) {
            console.error("Logout error", err);
            window.location.replace("/index.html");
          }
        }

        // load profile + KPIs
        function safeJSON(key) {
          try {
            return JSON.parse(localStorage.getItem(key));
          } catch (e) {
            return null;
          }
        }
        function computeAverage(history) {
          if (!history || history.length === 0) return 0;
          let totalPercent = 0,
            count = 0;
          history.forEach((h) => {
            const parts = (h.score || "").split("/");
            if (parts.length === 2) {
              const got = parseFloat(parts[0]) || 0;
              const tot = parseFloat(parts[1]) || 1;
              totalPercent += (got / tot) * 100;
              count++;
            }
          });
          if (count === 0) return 0;
          return Math.round(totalPercent / count);
        }

        function renderBadges({ attempts, passed, avg }) {
          const wrap = el("#badgesRow");
          if (!wrap) return;
          wrap.innerHTML = "";
          const scoreBadge = document.createElement("div");
          scoreBadge.className = "badge";
          scoreBadge.innerHTML = `<i class='bx bx-flame' style="color: #ff7a59"></i> Score ${avg}%`;
          wrap.appendChild(scoreBadge);
          const qBadge = document.createElement("div");
          qBadge.className = "badge";
          qBadge.innerHTML = `<i class='bx bx-medal' style="color: #f5b301"></i> ${attempts} Attempts`;
          wrap.appendChild(qBadge);
          const passBadge = document.createElement("div");
          passBadge.className = "badge";
          passBadge.innerHTML = `<i class='bx bx-award' style="color: #9b7cff"></i> ${passed} Passed`;
          wrap.appendChild(passBadge);
          if (avg < 50) {
            const help = document.createElement("div");
            help.className = "badge";
            help.style.background = "#fff6f6";
            help.style.color = "var(--danger)";
            help.innerHTML = `<i class='bx bx-support' style="color:var(--danger)"></i> Try Practice Mode`;
            wrap.appendChild(help);
          }
        }

        // render registered quizzes (with pagination)
        let regPage = 1,
          regPerPage = 3;
        let REGISTERED_QUIZZES = SAMPLE_REGISTERED.slice();
        function renderRegisteredQuizzes(page = 1) {
          const wrap = el("#registeredQuizzesWrap");
          if (!wrap) return;
          wrap.innerHTML = "";
          const searchVal =
            el("#searchInput") && el("#searchInput").value
              ? el("#searchInput").value.toLowerCase()
              : "";
          let filtered = REGISTERED_QUIZZES.filter((q) => {
            if (searchVal && searchVal !== "") {
              return (
                q.title.toLowerCase().includes(searchVal) ||
                (q.category && q.category.toLowerCase().includes(searchVal))
              );
            }
            return true;
          });

          const total = filtered.length;
          const pageCount = Math.max(1, Math.ceil(total / regPerPage));
          if (page > pageCount) page = pageCount;
          regPage = page;
          const start = (page - 1) * regPerPage;
          const pageItems = filtered.slice(start, start + regPerPage);

          if (pageItems.length === 0) {
            const note = document.createElement("div");
            note.textContent = "No registered quizzes.";
            note.style.color = "var(--muted)";
            wrap.appendChild(note);
          } else {
            pageItems.forEach((q) => {
              const card = document.createElement("div");
              card.className = "quiz-card";
              const hero = document.createElement("div");
              hero.className = "quiz-hero";
              const img = document.createElement("img");
              img.src = q.image || "";
              img.alt = q.title || "Quiz";
              img.addEventListener("error", () => fallbackImg(img));
              hero.appendChild(img);
              const body = document.createElement("div");
              body.className = "quiz-body";
              const title = document.createElement("div");
              title.className = "quiz-title";
              title.textContent = q.title;
              const meta = document.createElement("div");
              meta.className = "quiz-meta";
              meta.textContent = `${q.category} • ${q.type} • ${q.date}`;
              const actions = document.createElement("div");
              actions.className = "quiz-actions";
              const btnStart = document.createElement("button");
              btnStart.className = "btn btn-primary";
              btnStart.textContent = "▶ Start";
              btnStart.addEventListener(
                "click",
                () =>
                  (window.location.href = `quiz-play.html?quizId=${encodeURIComponent(
                    q.id
                  )}`)
              );
              const btnDetails = document.createElement("button");
              btnDetails.className = "btn btn-ghost-sm";
              btnDetails.textContent = "ℹ Details";
              btnDetails.addEventListener(
                "click",
                () =>
                  (window.location.href = `quiz-details.html?quizId=${encodeURIComponent(
                    q.id
                  )}`)
              );
              actions.appendChild(btnStart);
              actions.appendChild(btnDetails);
              body.appendChild(title);
              body.appendChild(meta);
              body.appendChild(actions);
              card.appendChild(hero);
              card.appendChild(body);
              wrap.appendChild(card);
            });
          }

          el("#regPageInfo") &&
            (el(
              "#regPageInfo"
            ).textContent = `Page ${regPage} of ${pageCount}`);
          const prevBtn = el("#regPrev"),
            nextBtn = el("#regNext");
          if (prevBtn) prevBtn.disabled = regPage <= 1;
          if (nextBtn) nextBtn.disabled = regPage >= pageCount;
        }

        el("#regPrev") &&
          el("#regPrev").addEventListener("click", () =>
            renderRegisteredQuizzes(Math.max(1, regPage - 1))
          );
        el("#regNext") &&
          el("#regNext").addEventListener("click", () =>
            renderRegisteredQuizzes(regPage + 1)
          );
        el("#searchInput") &&
          el("#searchInput").addEventListener("input", () =>
            renderRegisteredQuizzes(1)
          );

        // render history
        let histPage = 1,
          histPerPage = 5;
        let HISTORY = SAMPLE_HISTORY.slice();
        function renderHistory(page = 1) {
          const tbody = el("#historyBody");
          if (!tbody) return;
          tbody.innerHTML = "";
          const total = HISTORY.length;
          const pageCount = Math.max(1, Math.ceil(total / histPerPage));
          if (page > pageCount) page = pageCount;
          histPage = page;
          const start = (page - 1) * histPerPage;
          const pageItems = HISTORY.slice(start, start + histPerPage);
          pageItems.forEach((row) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td>${escapeHtml(row.title)}</td>
                        <td>${escapeHtml(row.category)}</td>
                        <td>${escapeHtml(row.type)}</td>
                        <td>${escapeHtml(row.date)}</td>
                        <td>${escapeHtml(row.score)}</td>
                        <td><span class="result-pill ${
                          row.result.toLowerCase() === "pass"
                            ? "result-pass"
                            : row.result.toLowerCase() === "fail"
                            ? "result-fail"
                            : "result-pending"
                        }">${escapeHtml(row.result)}</span></td>`;
            tbody.appendChild(tr);
          });
          el("#histPageInfo") &&
            (el(
              "#histPageInfo"
            ).textContent = `Page ${histPage} of ${pageCount}`);
          el("#histPrev") && (el("#histPrev").disabled = histPage <= 1);
          el("#histNext") && (el("#histNext").disabled = histPage >= pageCount);
        }
        el("#histPrev") &&
          el("#histPrev").addEventListener("click", () =>
            renderHistory(Math.max(1, histPage - 1))
          );
        el("#histNext") &&
          el("#histNext").addEventListener("click", () =>
            renderHistory(histPage + 1)
          );

        // attempt to fetch from backend; if fails, keep sample data
        async function loadFromBackend() {
          try {
            const token = localStorage.getItem("token");
            const headers = token ? { Authorization: "Bearer " + token } : {};
            const regRes = await fetch(
              backendUrl + "/user/registered-quizzes",
              { method: "GET", credentials: "include", headers }
            ).catch(() => null);
            if (regRes && regRes.ok) {
              const json = await regRes.json().catch(() => null);
              if (Array.isArray(json)) REGISTERED_QUIZZES = json;
              else if (Array.isArray(json.quizzes))
                REGISTERED_QUIZZES = json.quizzes;
            }
            const histRes = await fetch(backendUrl + "/user/history", {
              method: "GET",
              credentials: "include",
              headers,
            }).catch(() => null);
            if (histRes && histRes.ok) {
              const j = await histRes.json().catch(() => null);
              if (Array.isArray(j)) HISTORY = j;
              else if (Array.isArray(j.history)) HISTORY = j.history;
            }
          } catch (err) {
            console.warn("Backend load error (using sample data):", err);
          }
        }

        // load profile + KPIs based on history & registered
        function loadProfileAndKPIs(registeredList, historyList) {
          const user = safeJSON("user") || {
            name: "Kudoz Kundan",
            role: "Student",
            course: "Computer Science",
          };
          const avatarUrl =
            localStorage.getItem("osian_profile_image") ||
            "https://images.unsplash.com/photo-1544005313-94ddf0286df2?auto=format&fit=crop&w=400&q=80";
          const avatar = el("#profileAvatar");
          avatar.src = avatarUrl;
          avatar.alt = user.name;
          avatar.onerror = () => fallbackImg(avatar);
          el("#profileName").textContent = user.name || "User";
          el("#profileMeta").textContent = `${user.role || "Student"} • ${
            user.course || ""
          }`;

          const attempts = (historyList || SAMPLE_HISTORY).length;
          const passed = (historyList || SAMPLE_HISTORY).filter(
            (h) => (h.result || "").toLowerCase() === "pass"
          ).length;
          const avg = computeAverage(historyList || SAMPLE_HISTORY);

          el("#kpiAttempt").textContent = attempts;
          el("#kpiPassed").textContent = passed;
          el("#kpiAvg").textContent = avg + "%";

          renderBadges({ attempts, passed, avg });
        }

        // INITIALIZE
        async function boot() {
          // wire up logout & navigation
          el("#sidebar-logout") &&
            el("#sidebar-logout").addEventListener("click", (e) => {
              e.preventDefault();
              doLogout();
            });
          el("#btn-logout-header") &&
            el("#btn-logout-header").addEventListener("click", (e) => {
              e.preventDefault();
              doLogout();
            });
          el("#sidebar-dashboard-btn") &&
            el("#sidebar-dashboard-btn").addEventListener(
              "click",
              () => (window.location.href = "dashboard-user.html")
            );
          el("#btn-switch-view") &&
            el("#btn-switch-view").addEventListener(
              "click",
              () => (window.location.href = "dashboard-user.html")
            );

          el("#btnNewQuiz") &&
            el("#btnNewQuiz").addEventListener("click", () => {
              window.location.href = "create-quiz.html";
            });
          el("#btn-refresh") &&
            el("#btn-refresh").addEventListener("click", async () => {
              el("#btn-refresh").textContent = "Refreshing...";
              await loadFromBackend();
              loadProfileAndKPIs(REGISTERED_QUIZZES, HISTORY);
              renderRegisteredQuizzes(1);
              renderHistory(1);
              setTimeout(
                () =>
                  el("#btn-refresh") &&
                  (el("#btn-refresh").textContent = "Refresh"),
                900
              );
            });

          // load remote data if available
          await loadFromBackend();

          // initial render
          loadProfileAndKPIs(REGISTERED_QUIZZES, HISTORY);
          renderRegisteredQuizzes(1);
          renderHistory(1);

          // image fallback handlers
          qAll("img").forEach((img) =>
            img.addEventListener("error", () => fallbackImg(img))
          );
        }

        document.addEventListener("DOMContentLoaded", boot);
      })();
    </script>
  </body>
</html>
